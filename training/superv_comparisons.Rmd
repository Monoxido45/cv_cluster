---
title: "Some supervised learning tests for Dendrogram Score"
output:
  html_document:
    df_print: paged
  word_document: default
---
```{r global_options}
```
Importing needed packages
```{r message = FALSE}
library(ape)
library(dendextend)
library(cluster)
library(tibble)
library(magrittr)
library(dplyr)
library(phytools)
library(mltools)
library(data.table)
library(factoextra)
source("C:/Users/lucru/Estatística_UFSCar/cv_cluster/modules/convert_to_parenthesis.R")
source("C:/Users/lucru/Estatística_UFSCar/cv_cluster/modules/cv_score.R")
library(tictoc)
library(mvMORPH)
library(dplyr)
library(tidyr)
library(RColorBrewer)
library(MASS)
library(kableExtra)
library(plyr)
library(clValid)
```
First working with a simulated data set:
```{r}
set.seed(500)
n = 170
p = 2

Y = sample(c(0, 1), n, replace = TRUE, prob = c(0.5, 0.5))
mu_0 = c(0, 0)
mu_1 = c(1, 2)
S = cbind(c(2, 1), c(1, 3))


X = matrix(nrow = n, ncol = p)
X[Y == 0, ] = round(mvrnorm(sum(Y == 0), mu_0, S), 4)
X[Y == 1, ] = round(mvrnorm(sum(Y == 1), mu_1, S), 4)

sim.data = as.data.frame(cbind(X , Y))
sim.data$Y = as.factor(Y)
colnames(sim.data) = c("X1", "X2", "Y")
row.names(sim.data) = c(1:nrow(sim.data))
head(sim.data, 4)
```
So lets make some tests:
```{r}
lvls = levels(sim.data$Y)
tam = length(lvls)
relab_y = mapvalues(sim.data$Y, from = lvls, to = 1:tam)
relab_y
new_lvls = levels(relab_y)
```
And now testing some hierarchical clustering without the ground truth label:
```{r}
test_data = sim.data[, -3]
d = dist(test_data)
diana1 = diana(d)
diana2 = diana(d, diss = T)
```
```{r}
test.wd_hc = scale(test_data) %>%
  dist() %>%
  hclust()
cluster = factor(cutree(test.wd_hc, k = 2))
cluster
```
```{r}
test.diana = scale(test_data) %>%
  diana()
fit = cutree(test.diana, k = 2)
fit
```


```{r}
perms = permutations(n = tam, r = tam,v =  new_lvls)
perms
```
And now, we can obtain all possible combinations of cluster labels:
```{r}
hits = numeric(nrow(perms))
for(i in (1:nrow(perms))){
  new_clust = mapvalues(cluster, from = levels(cluster), to = perms[i, ])
  temp_hit = (sum(new_clust == relab_y)/length(relab_y))
  hits[i] = temp_hit
}
hits
which.max(hits)
```
Based on this, we can make a comparison function between a supervised learning prediction score computed into hierarchical clustering with ward.D2 method with our score:
```{r}
tic("Time of the supervised comparison")
comp = supervised_comparing(sim.data, clust = "hclust", clust_method = "ward.D2", test_index = 3)
comp
toc()
```
Testing the list input for supervised_comparing and cv_score algorithms:
```{r}
test.list = list(hclust = c("ward.D", "single","ward.D2", "average", "complete", "mcquitty", "median", "centroid"), agnes = c("weighted", "average", "ward"), diana = NA)
names(test.list)
test.list[[3]]
```
```{r}
paste0(names(test.list)[1], test.list[[1]][1])
```
Running all supervised comparisons:
```{r}
tic("Running time for all_supervised_comparing")
data.test = all_supervised_comparing(sim.data, clust = test.list, test_index = 3)
data.test
toc()
```
Graphing the comparisson:
```{r}
data.test %>%
  mutate(names = rownames(data.test)) %>% 
  ggplot(aes(x = V1, y = V3)) +
  geom_point(color = "red") +
  labs(x = "Proportion of hits",
       y = "Scores") +
  theme_minimal()
```
\
```{r}
dists = c("euclidean", "manhattan", "canberra", "minkowski")
tic("Running time for all_supervised_comparing")
data.test = all_supervised_comparing(sim.data, clust = test.list, test_index = 3, dist = dists)
data.test
toc()
```
Graphing the comparison acording to distance:
```{r echo=TRUE}
data.test = data.test %>%
  mutate(V1 = as.numeric(V1),
         V2 = as.numeric(V2),
         V3 = as.numeric(V3),
         V4 = as.factor(V4))
data.test %>%
  ggplot(aes(x = V1, y = V3, colour = V4)) +
  geom_point() +
  theme_minimal() +
  labs(x = "Proportion of hits",
       y = "Scores",
       colour = "Distances",
       title = "Scatterplot of proportion of hits versus Score values 
       according to different distances") +
  theme(text = element_text(size = 11, 
                            family ="serif"),
        plot.title = element_text(hjust = 0.5)) +
  scale_colour_brewer(palette = "Set1")
```
```{r}
data.test %>%
  ggplot(aes(x = V2, y = V3, colour = V4)) +
  geom_point() +
  theme_minimal() +
  labs(x = "F1 score",
       y = "Scores",
       colour = "Distances",
       title = "Scatterplot of F1 versus Score values 
       according to different distances") +
  theme(text = element_text(size = 11, 
                            family ="serif"),
        plot.title = element_text(hjust = 0.5)) +
  scale_colour_brewer(palette = "Set1")
```
```{r}
cor(data.test$V2, data.test$V3, method = "spearman")
```
Testing iris dataset:
```{r}
flowers = iris
tic("Running time for all_supervised_comparing in iris dataset")
iris.test = all_supervised_comparing(flowers, clust = test.list, test_index = 5, dist = dists)
iris.test
toc()
```
And then, graphing it:
**Proportion of hits versus Score values**
```{r echo = F}
iris.test = iris.test %>%
  mutate(V1 = as.numeric(V1),
         V2 = as.numeric(V2),
         V3 = as.numeric(V3),
         V4 = as.factor(V4))

iris.test %>%
  ggplot(aes(x = V1, y = V3, colour = V4)) +
  geom_point() +
  theme_minimal() +
  labs(x = "Proportion of hits",
       y = "Scores",
       colour = "Distances",
       title = "Scatterplot of proportion of hits versus Score values 
       according to different distances") +
    theme(text = element_text(size = 11, 
                            family ="serif"),
        plot.title = element_text(hjust = 0.5))+
  scale_colour_brewer(palette = "Set1")
```
\
**F1 versus Score values**
```{r}
iris.test %>%
  ggplot(aes(x = V2, y = V3, colour = V4)) +
  geom_point() +
  theme_minimal() +
  labs(x = "F1 score",
       y = "Scores",
       colour = "Distances",
       title = "Scatterplot of F1 versus Score values 
       according to different distances") +
  theme(text = element_text(size = 11, 
                            family ="serif"),
        plot.title = element_text(hjust = 0.5)) +
  scale_colour_brewer(palette = "Set1")
```
\
Testing supervisioned comparisson for cross validation score
```{r}
cl.list = list(hclust = c("single","ward.D2", "mcquitty", "average", "centroid", "complete",
                          "ward.D"), 
               agnes = c("weighted", "average"), diana = NULL)
dists = c("euclidean", "manhattan", "canberra", "maximum")
tic("Running time for all_supervised_comparing")
cv.data.test = supervised_comparing_L_cross_val(sim.data, cl.list, test_index = 3, 
                                             dists = dists)
head(cv.data.test, 10)
toc()
```
```{r}
cv.data.test %>%
  ggplot(aes(x = V1, y = hits, colour = dist_names)) +
  geom_point() +
  theme_minimal() +
  labs(x = "Scores",
       y = "Proportion of hits",
       colour = "Distances",
       title = "Scatterplot of proportion of hits versus Score values 
       according to different distances") +
  theme(text = element_text(size = 11, 
                            family ="serif"),
        plot.title = element_text(hjust = 0.5))+
  scale_colour_brewer(palette = "Set1") +
  coord_flip()
```
```{r}
cv.data.test %>%
  ggplot(aes(x = V1, y = F1, colour = dist_names)) +
  geom_point() +
  theme_minimal() +
  labs(x = "Scores",
       y = "F1",
       colour = "Distances",
       title = "Scatterplot of F1 versus Score values 
       according to different distances") +
  theme(text = element_text(size = 11, 
                            family ="serif"),
        plot.title = element_text(hjust = 0.5))+
  scale_colour_brewer(palette = "Set1") +
  coord_flip()
```







